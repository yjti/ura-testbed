<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>URA DMP2025 Fringe Events</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <img src="ura-logo.png" alt="URA Logo" />
    <div class="header-text">
      <div class="title-block">
        <strong>DMP2025 Fringe Events</strong>
        <span class="subtitle"><em>Join our activities! Discover upcoming fringe events where you can learn, experience, and contribute to the Draft Master Plan 2025.</em></span>
      </div>
    </div>
  </header>

  <main class="event-list" id="eventList"></main>

  <script>
    // Live reload every 30 mins
    const CHECK_INTERVAL = 1800000; 
    let currentVersion = null;

    async function checkVersion() {
      try {
        const response = await fetch('version.json', { cache: 'no-store' });
        const latestVersion = await response.text();

        if (currentVersion === null) {
          currentVersion = latestVersion.trim();
        } else if (latestVersion.trim() !== currentVersion) {
          console.log('New version detected, reloading...');
          location.reload(true);
        }
      } catch (e) {
        console.error('Version check failed:', e);
      }
    }

    setInterval(checkVersion, CHECK_INTERVAL);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      loadEvents();
    });

    async function loadEvents() {
      const response = await fetch("events.json");
      const events = await response.json();
      const container = document.getElementById("eventList");
      const today = new Date();

      events.forEach(event => {
        const endDate = new Date(event.endDate + "T23:59:59");

        if (today > endDate) return; // Skip past events

        const card = document.createElement("div");
        card.className = "event-card";
        card.setAttribute("data-status", event.status);

        const status = event.status;
        const bgColor = status === "sold-out" ? "#d72c11" : "#02a630";
        const labelColor = status === "sold-out" ? "#710000" : "";
        const labelTextColor = status === "sold-out" ? "#ffffff" : "";
        const labelText = status === "sold-out" ? "Sold Out" : "Sign-Ups Open";
        const qrImage = status === "sold-out" ? event.soldOutQr : event.qr;

        card.innerHTML = `
          <div class="image-container">
            <img src="${event.image}" alt="${event.title}" class="event-image" />
          </div>
          <div class="event-details">
            <div class="event-top">
              <div class="event-tags">
                <span class="tag date">${formatDate(event.date)} â€“ ${formatDate(event.endDate)}</span>
                <span class="tag type type-${event.type.toLowerCase().replace(/\s+/g, '-')}">
                  ${formatType(event.type)}
              </div>
            </div>
            <div class="event-middle">
              <h2 class="event-title">${event.title}</h2>
              <p class="event-description">${event.description}</p>
            </div>
          </div>
          <div class="qr-container" style="background-color: ${bgColor}">
            <span class="qr-label" style="background-color: ${labelColor}; color: ${labelTextColor};">${labelText}</span>
            <img src="${qrImage}" class="qr-code" />
          </div>
        `;

        container.appendChild(card);
      });
    }

    function formatDate(dateStr) {
      const options = { day: '2-digit', month: 'short' };
      return new Date(dateStr).toLocaleDateString('en-GB', options);
    }
    function formatType(type) {
      return type
        .split(/(?=[A-Z])|[\s_-]/) // split camelCase or snake_case or kebab-case
        .filter(Boolean)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
  </script>
</body>
</html>
